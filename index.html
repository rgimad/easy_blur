<!DOCTYPE html> 
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Pro Blur Tool</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .toolbar { display: flex; gap: 15px; background: #222; padding: 12px 20px; border-radius: 12px; margin-bottom: 20px; align-items: center; box-shadow: 0 8px 24px rgba(0,0,0,0.4); flex-wrap: wrap; }
        .group { display: flex; flex-direction: column; gap: 4px; border-right: 1px solid #444; padding-right: 15px; }
        .group:last-child { border: none; }
        label { font-size: 10px; text-transform: uppercase; color: #888; font-weight: bold; }
        #wrapper { position: relative; border: 1px solid #333; line-height: 0; cursor: crosshair; user-select: none; background: #000; overflow: hidden; }
        canvas { max-width: 90vw; max-height: 75vh; display: block; }
        #selector { position: absolute; border: 1px solid #007aff; background: rgba(0, 122, 255, 0.2); pointer-events: none; display: none; box-sizing: border-box; z-index: 10; }
        button { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; background: #007aff; color: white; font-weight: 500; font-size: 13px; }
        button.sec { background: #444; }
        button.danger { background: #eb445a; }
        button:active { opacity: 0.7; }
        select, input[type="range"] { background: #333; color: white; border: 1px solid #444; border-radius: 4px; padding: 4px; outline: none; }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="group">
            <label>Файл</label>
            <div style="display:flex; gap:5px">
                <button onclick="document.getElementById('loader').click()">Открыть</button>
                <button class="sec" onclick="undo()">Undo</button>
            </div>
            <input type="file" id="loader" accept="image/*" style="display:none">
        </div>

        <div class="group">
            <label>Эффект</label>
            <select id="blurType">
                <option value="soft">Мягкий</option>
                <option value="heavy">Сильный</option>
                <option value="pixel">Пиксели</option>
            </select>
        </div>

        <div class="group">
            <label>Сила: <span id="val">50</span>%</label>
            <input type="range" id="strength" min="5" max="98" value="50" oninput="document.getElementById('val').innerText=this.value">
        </div>

        <div class="group">
            <label>Экспорт</label>
            <div style="display:flex; gap:5px">
                <button class="sec" onclick="copyToClipboard()">Копировать</button>
                <button class="sec" onclick="saveImage()">PNG</button>
                <button class="danger" onclick="resetAll()">Сброс</button>
            </div>
        </div>
    </div>

    <div id="wrapper">
        <canvas id="canvas"></canvas>
        <div id="selector"></div>
    </div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const wrapper = document.getElementById('wrapper');
    const selector = document.getElementById('selector');
    
    let history = []; // Стек для отмены (Undo)
    let isDragging = false;
    let startX, startY;

    // --- Загрузка ---
    function initImage(dataUrl) {
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            saveHistory(); // Сохраняем начальное состояние
        };
        img.src = dataUrl;
    }

    document.getElementById('loader').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => initImage(ev.target.result);
        reader.readAsDataURL(e.target.files[0]);
    };

    window.addEventListener('paste', (e) => {
        const item = Array.from(e.clipboardData.items).find(i => i.type.includes('image'));
        if (item) {
            const reader = new FileReader();
            reader.onload = (ev) => initImage(ev.target.result);
            reader.readAsDataURL(item.getAsFile());
        }
    });

    // --- Логика выделения (Screen Space) ---
    wrapper.onmousedown = (e) => {
        if (canvas.width === 0) return;
        isDragging = true;
        const rect = wrapper.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;

        selector.style.display = 'block';
        selector.style.left = startX + 'px';
        selector.style.top = startY + 'px';
        selector.style.width = '0px';
        selector.style.height = '0px';
    };

    window.onmousemove = (e) => {
        if (!isDragging) return;
        const rect = wrapper.getBoundingClientRect();
        const curX = e.clientX - rect.left;
        const curY = e.clientY - rect.top;

        selector.style.left = Math.min(startX, curX) + 'px';
        selector.style.top = Math.min(startY, curY) + 'px';
        selector.style.width = Math.abs(curX - startX) + 'px';
        selector.style.height = Math.abs(curY - startY) + 'px';
    };

    window.onmouseup = () => {
        if (!isDragging) return;
        isDragging = false;

        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        const x = parseFloat(selector.style.left) * scaleX;
        const y = parseFloat(selector.style.top) * scaleY;
        const w = parseFloat(selector.style.width) * scaleX;
        const h = parseFloat(selector.style.height) * scaleY;

        if (w > 2 && h > 2) {
            saveHistory(); // Сохраняем перед изменением
            applyEffect(x, y, w, h);
        }
        selector.style.display = 'none';
    };

    // --- Эффекты ---
    function applyEffect(x, y, w, h) {
        const type = document.getElementById('blurType').value;
        const strength = parseInt(document.getElementById('strength').value);
        const scale = (101 - strength) / 100;

        const temp = document.createElement('canvas');
        temp.width = Math.max(1, w * scale);
        temp.height = Math.max(1, h * scale);
        const tCtx = temp.getContext('2d');

        // Рендеринг
        if (type === 'pixel') {
            ctx.imageSmoothingEnabled = false;
            tCtx.imageSmoothingEnabled = false;
        } else {
            ctx.imageSmoothingEnabled = true;
            tCtx.imageSmoothingEnabled = true;
        }

        tCtx.drawImage(canvas, x, y, w, h, 0, 0, temp.width, temp.height);

        if (type === 'heavy') {
            ctx.save();
            ctx.filter = `blur(${strength / 4}px)`;
            ctx.drawImage(temp, 0, 0, temp.width, temp.height, x, y, w, h);
            ctx.restore();
        } else {
            ctx.drawImage(temp, 0, 0, temp.width, temp.height, x, y, w, h);
        }
        ctx.filter = 'none';
    }

    // --- История и Кнопки ---
    function saveHistory() {
        history.push(canvas.toDataURL());
        if (history.length > 20) history.shift();
    }

    function undo() {
        if (history.length > 1) {
            history.pop(); // Удаляем текущее
            const lastState = history[history.length - 1];
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = lastState;
        }
    }

    function resetAll() {
        if (history.length > 0) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                history = [history[0]]; // Оставляем только первый кадр
            };
            img.src = history[0];
        }
    }

    function saveImage() {
        const link = document.createElement('a');
        link.download = 'edited.png';
        link.href = canvas.toDataURL();
        link.click();
    }

    async function copyToClipboard() {
        try {
            // Проверка поддержки API
            if (!typeof ClipboardItem !== "undefined") {
                alert("Ваш браузер не поддерживает современный Clipboard API");
                return;
            }

            // В Safari важно передавать Promise прямо в ClipboardItem, 
            // чтобы не разрывать контекст пользовательского клика
            const item = new ClipboardItem({
                "image/png": new Promise((resolve) => {
                    canvas.toBlob((blob) => resolve(blob), "image/png");
                }),
            });

            await navigator.clipboard.write([item]);
            
            // Красивое уведомление на кнопке
            const btn = event.currentTarget || document.activeElement;
            const oldText = btn.innerText;
            btn.innerText = "Скопировано! ✅";
            setTimeout(() => btn.innerText = oldText, 2000);

        } catch (err) {
            console.error("Ошибка копирования:", err);
            alert("Не удалось скопировать. Попробуйте еще раз или используйте Chrome/Edge.");
        }
    }


    // Hotkeys
    window.onkeydown = (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'z') undo();
    };
</script>
</body>
</html>
