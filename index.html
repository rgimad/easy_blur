<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blur Tool Pro — Safari Ready</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        
        /* Панель управления */
        .toolbar { display: flex; gap: 15px; background: #222; padding: 12px 20px; border-radius: 12px; margin-bottom: 20px; align-items: center; box-shadow: 0 8px 24px rgba(0,0,0,0.4); flex-wrap: wrap; }
        .group { display: flex; flex-direction: column; gap: 4px; border-right: 1px solid #444; padding-right: 15px; }
        .group:last-child { border: none; }
        label { font-size: 10px; text-transform: uppercase; color: #888; font-weight: bold; }
        
        /* Холст и выделение */
        #wrapper { position: relative; border: 1px solid #333; line-height: 0; cursor: crosshair; user-select: none; background: #000; overflow: hidden; border-radius: 4px; }
        canvas { max-width: 90vw; max-height: 70vh; display: block; transition: filter 0.1s; }
        #selector { position: absolute; border: 1px solid #007aff; background: rgba(0, 122, 255, 0.2); pointer-events: none; display: none; box-sizing: border-box; z-index: 10; }
        
        /* Кнопки и инпуты */
        button { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; background: #007aff; color: white; font-weight: 500; font-size: 13px; transition: 0.2s; }
        button.sec { background: #444; }
        button.danger { background: #eb445a; }
        button:hover { opacity: 0.8; }
        button:active { transform: scale(0.95); }
        select, input[type="range"] { background: #333; color: white; border: 1px solid #444; border-radius: 4px; padding: 4px; outline: none; }
        
        /* Вспышка при копировании */
        .flash { filter: brightness(1.5); }

        /* Панель инструкции */
        .info-panel { margin-top: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; max-width: 900px; width: 90vw; background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #333; box-sizing: border-box; }
        .info-item { font-size: 13px; color: #ccc; line-height: 1.6; }
        .info-item strong { display: block; color: #007aff; margin-bottom: 4px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-item span { background: #333; padding: 2px 6px; border-radius: 4px; color: #fff; font-family: monospace; border: 1px solid #444; }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="group">
            <label>Файл</label>
            <div style="display:flex; gap:5px">
                <button onclick="document.getElementById('loader').click()">Открыть</button>
                <button class="sec" onclick="undo()">Отмена</button>
            </div>
            <input type="file" id="loader" accept="image/*" style="display:none">
        </div>

        <div class="group">
            <label>Эффект</label>
            <select id="blurType">
                <option value="soft">Мягкий блюр</option>
                <option value="heavy">Сильное размытие</option>
                <option value="pixel">Пикселизация</option>
            </select>
        </div>

        <div class="group">
            <label>Сила: <span id="val">-</span>%</label>
            <input type="range" id="strength" min="5" max="98" value="88" oninput="document.getElementById('val').innerText=this.value">
        </div>

        <div class="group">
            <label>Экспорт</label>
            <div style="display:flex; gap:5px">
                <button id="copyBtn" class="sec" onclick="copyToClipboard()">Копировать</button>
                <button class="sec" onclick="saveImage()">Скачать PNG</button>
                <button class="danger" onclick="resetAll()">Сброс</button>
            </div>
        </div>
    </div>

    <div id="wrapper">
        <canvas id="canvas"></canvas>
        <div id="selector"></div>
    </div>

    <div class="info-panel">
        <div class="info-item">
            <strong>Загрузка</strong> 
            Нажми <span>Cmd+V</span> для вставки из буфера или выбери файл кнопкой «Открыть».
        </div>
        <div class="info-item">
            <strong>Размытие</strong> 
            Просто <span>выдели область</span> мышкой на изображении. Эффект применится мгновенно.
        </div>
        <div class="info-item">
            <strong>Настройки</strong> 
            Меняй тип и силу эффекта в меню сверху перед тем, как выделять область.
        </div>
        <div class="info-item">
            <strong>Горячие клавиши</strong> 
            Используй <span>Cmd+Z</span> для отмены последнего действия. Сброс очистит всё.
        </div>
    </div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const wrapper = document.getElementById('wrapper');
    const selector = document.getElementById('selector');
    
    let history = []; 
    let isDragging = false;
    let startX, startY;

    function initImage(dataUrl) {
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            history = []; 
            saveHistory();
        };
        img.src = dataUrl;
    }

    document.getElementById('loader').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => initImage(ev.target.result);
        reader.readAsDataURL(e.target.files[0]);
    };

    window.addEventListener('paste', (e) => {
        const item = Array.from(e.clipboardData.items).find(i => i.type.includes('image'));
        if (item) {
            const reader = new FileReader();
            reader.onload = (ev) => initImage(ev.target.result);
            reader.readAsDataURL(item.getAsFile());
        }
    });

    // Выделение
    wrapper.onmousedown = (e) => {
        if (canvas.width === 0) return;
        isDragging = true;
        const rect = wrapper.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        selector.style.display = 'block';
        selector.style.left = startX + 'px';
        selector.style.top = startY + 'px';
        selector.style.width = '0px';
        selector.style.height = '0px';
    };

    window.onmousemove = (e) => {
        if (!isDragging) return;
        const rect = wrapper.getBoundingClientRect();
        const curX = e.clientX - rect.left;
        const curY = e.clientY - rect.top;
        selector.style.left = Math.min(startX, curX) + 'px';
        selector.style.top = Math.min(startY, curY) + 'px';
        selector.style.width = Math.abs(curX - startX) + 'px';
        selector.style.height = Math.abs(curY - startY) + 'px';
    };

    window.onmouseup = () => {
        if (!isDragging) return;
        isDragging = false;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = parseFloat(selector.style.left) * scaleX;
        const y = parseFloat(selector.style.top) * scaleY;
        const w = parseFloat(selector.style.width) * scaleX;
        const h = parseFloat(selector.style.height) * scaleY;

        if (w > 2 && h > 2) {
            saveHistory(); 
            applyEffect(x, y, w, h);
        }
        selector.style.display = 'none';
    };

    function applyEffect(x, y, w, h) {
        const type = document.getElementById('blurType').value;
        const strength = parseInt(document.getElementById('strength').value);
        const scale = (101 - strength) / 100;
        const temp = document.createElement('canvas');
        temp.width = Math.max(1, w * scale);
        temp.height = Math.max(1, h * scale);
        const tCtx = temp.getContext('2d');

        ctx.imageSmoothingEnabled = (type !== 'pixel');
        tCtx.imageSmoothingEnabled = (type !== 'pixel');
        tCtx.drawImage(canvas, x, y, w, h, 0, 0, temp.width, temp.height);

        if (type === 'heavy') {
            ctx.save();
            ctx.filter = `blur(${strength / 4}px)`;
            ctx.drawImage(temp, 0, 0, temp.width, temp.height, x, y, w, h);
            ctx.restore();
        } else {
            ctx.drawImage(temp, 0, 0, temp.width, temp.height, x, y, w, h);
        }
        ctx.filter = 'none';
    }

    function saveHistory() {
        history.push(canvas.toDataURL('image/png'));
        if (history.length > 20) history.shift();
    }

    function undo() {
        if (history.length > 1) {
            history.pop();
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = history[history.length - 1];
        }
    }

    function resetAll() {
        if (history.length > 0) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                const firstState = history[0];
                history = [firstState];
            };
            img.src = history[0];
        }
    }

    // Экспорт
    function saveImage() {
        const link = document.createElement('a');
        link.download = 'blurred_image.png';
        link.href = canvas.toDataURL();
        link.click();
    }

    async function copyToClipboard() {
        if (typeof ClipboardItem === "undefined") {
            alert("Clipboard API не поддерживается.");
            return;
        }
        try {
            const item = new ClipboardItem({
                "image/png": new Promise((resolve) => {
                    canvas.toBlob((blob) => resolve(blob), "image/png");
                })
            });
            await navigator.clipboard.write([item]);
            
            canvas.classList.add('flash');
            setTimeout(() => canvas.classList.remove('flash'), 300);
            
            const btn = document.getElementById('copyBtn');
            const old = btn.innerText;
            btn.innerText = "Скопировано! ✅";
            setTimeout(() => btn.innerText = old, 2000);
        } catch (err) {
            alert("Ошибка буфера. Нужен HTTPS.");
        }
    }

    window.onkeydown = (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'z') {
            e.preventDefault();
            undo();
        }
    };

    // Синхронизация текста с ползунком при загрузке страницы
    document.getElementById('val').innerText = document.getElementById('strength').value;

</script>
</body>
</html>
